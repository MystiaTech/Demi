---
phase: 07-autonomy-&-rambles
plan: 04
type: execute
wave: 2
depends_on: [07-01, 07-02, 07-03]
files_modified: [src/autonomy/coordinator.py, src/integrations/discord_bot.py, src/api/autonomy.py, src/conductor/orchestrator.py]
autonomous: true
must_haves:
  truths:
    - "Unified autonomy system replaces platform-specific autonomy implementations"
    - "Discord and Android share consistent autonomous behavior patterns"
    - "Emotional state changes sync across platforms in real-time"
    - "Background task coordination prevents conflicts and resource contention"
  artifacts:
    - path: "src/autonomy/coordinator.py"
      provides: "Complete unified autonomy coordination system"
      min_lines: 150
    - path: "src/integrations/discord_bot.py"
      provides: "Updated Discord bot using unified autonomy system"
      min_lines: 400
    - path: "src/api/autonomy.py"
      provides: "Updated Android autonomy using unified system"
      min_lines: 400
  key_links:
    - from: "src/conductor/orchestrator.py"
      to: "src/autonomy/coordinator.py"
      via: "main conductor integration"
      pattern: "AutonomyCoordinator\\."
    - from: "src/integrations/discord_bot.py"
      to: "src/autonomy/coordinator.py"
      via: "discord platform integration"
      pattern: "autonomy_coordinator\\."
    - from: "src/api/autonomy.py"
      to: "src/autonomy/coordinator.py"
      via: "android platform integration"
      pattern: "autonomy_coordinator\\."
---

<objective>
Integrate unified autonomy system across Discord and Android platforms, replacing platform-specific implementations with centralized coordination. Ensure consistent autonomous behavior, real-time emotional state synchronization, and seamless background task management.

Purpose: Complete AUTO-03, AUTO-04, AUTO-05 requirements with unified, consistent autonomy across all platforms.
Output: Fully integrated unified autonomy system with platform-specific message delivery.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-autonomy-&-rambles/07-RESEARCH.md
@src/conductor/orchestrator.py
@src/integrations/discord_bot.py
@src/api/autonomy.py
@src/autonomy/coordinator.py
@src/autonomy/spontaneous.py
@src/autonomy/refusals.py
</context>

<tasks>

<task type="auto">
  <name>Integrate autonomy coordinator into main conductor orchestrator</name>
  <files>src/conductor/orchestrator.py</files>
  <action>Update Conductor orchestrator to integrate unified autonomy system:
- Add AutonomyCoordinator initialization in conductor startup sequence
- Include autonomy system in health monitoring and status reporting
- Implement proper shutdown sequence for autonomous background tasks
- Add autonomy system to resource monitoring and auto-scaling considerations

Key additions:
- self.autonomy_coordinator = AutonomyCoordinator(self, self.logger) in __init__
- _start_autonomy_system() method in startup sequence (after LLM initialization)
- _stop_autonomy_system() method in graceful shutdown
- Add autonomy status to get_system_status() method
- Include autonomy resources in resource monitoring calculations

Implementation details:
- Initialize autonomy after LLM and platforms are ready
- Pass conductor reference to autonomy coordinator for platform access
- Add autonomy health checks to existing health monitoring
- Ensure proper cleanup during shutdown to prevent task leaks
- Log autonomy system startup/shutdown events appropriately

Update conductor's request routing to handle autonomy-related requests if needed.
</action>
  <verify>python -c "from src.conductor.orchestrator import Conductor; print('Conductor integrates autonomy system successfully')"</verify>
  <done>Conductor orchestrator updated with unified autonomy system integration</done>
</task>

<task type="auto">
  <name>Update Discord bot to use unified autonomy system</name>
  <files>src/integrations/discord_bot.py</files>
  <action>Replace Discord-specific autonomy with unified system:
- Remove existing RambleTask and platform-specific autonomy logic
- Integrate with AutonomyCoordinator for all autonomous behavior
- Update Discord bot lifecycle to start/stop unified autonomy
- Maintain Discord-specific message formatting and delivery

Major changes:
- Remove @tasks.loop decorators for ramble checking
- Add self.autonomy_coordinator reference from conductor
- Update on_ready to start unified autonomy via coordinator
- Remove should_generate_ramble() and related functions
- Keep Discord-specific formatting (embeds, colors) but use unified content
- Update message handlers to interact with unified autonomy system

Implementation details:
- Import AutonomyCoordinator and related components
- Replace RambleTask.start() with autonomy_coordinator.start_autonomy()
- Update Discord-specific message delivery methods to work with unified content
- Ensure emotional state updates flow through unified system
- Maintain Discord bot error handling and recovery patterns
- Add Discord platform adapter for unified autonomy message delivery

Test that Discord rambles, check-ins, and spontaneous messages work through unified system.
</action>
  <verify>python -c "from src.integrations.discord_bot import DiscordBot; print('Discord bot uses unified autonomy system')"</verify>
  <done>Discord bot updated to use unified autonomy system with platform-specific formatting</done>
</task>

<task type="auto">
  <name>Update Android autonomy to use unified system</name>
  <files>src/api/autonomy.py</files>
  <action>Replace Android-specific autonomy with unified system:
- Remove existing AutonomyTask and platform-specific logic
- Integrate with AutonomyCoordinator for all autonomous behavior
- Update Android app lifecycle to coordinate with unified autonomy
- Maintain Android-specific WebSocket delivery and notification systems

Major changes:
- Remove AutonomyTask class and @tasks.loop decorators
- Add autonomy_coordinator integration from FastAPI app
- Update startup/shutdown hooks to use unified system
- Remove check_if_ignored() and should_send_checkin() local implementations
- Keep Android-specific WebSocket delivery and notification logic
- Update message handling to interact with unified autonomy system

Implementation details:
- Import AutonomyCoordinator from unified autonomy module
- Replace background task management with coordinator.start_autonomy()
- Update WebSocket message delivery to work with unified content
- Ensure emotional state consistency across Discord and Android
- Maintain Android notification system for autonomous messages
- Add Android platform adapter for unified autonomy message delivery
- Update autonomous message tracking to use unified persistence

Test that Android check-ins, guilt-trips, and spontaneous messages work through unified system.
</action>
  <verify>python -c "from src.api.autonomy import AutonomyManager; print('Android autonomy uses unified system')"</verify>
  <done>Android autonomy updated to use unified system with platform-specific delivery</done>
</task>

<task type="auto">
  <name>Final integration testing and system validation</name>
  <files>tests/test_unified_autonomy.py</files>
  <action>Create comprehensive integration tests for unified autonomy system:
- Test cross-platform emotional state synchronization
- Verify consistent autonomous behavior across Discord and Android
- Test background task coordination and resource management
- Validate spontaneous initiation, check-ins, and refusal patterns
- Test platform-specific message delivery with unified content

Test scenarios:
- Emotional state update on Discord reflects in Android autonomy
- Spontaneous initiation chooses appropriate platform based on user activity
- Refusal system works consistently across all platforms
- Background task cleanup prevents memory leaks during shutdown
- Resource monitoring includes autonomy system correctly
- Platform adapters maintain formatting while using unified logic

Integration tests should cover:
- Full autonomy startup sequence through conductor
- Emotional trigger evaluation and action execution
- Cross-platform message delivery and formatting
- Error handling and recovery scenarios
- Performance under load (multiple simultaneous triggers)

Ensure all autonomy requirements (AUTO-03, AUTO-04, AUTO-05) are fully satisfied.
</action>
  <verify>python -m pytest tests/test_unified_autonomy.py -v</verify>
  <done>Comprehensive integration tests created and passing for unified autonomy system</done>
</task>

</tasks>

<verification>
Verify unified autonomy integration:
1. Conductor orchestrator properly initializes and manages autonomy system
2. Discord bot uses unified autonomy while maintaining platform-specific formatting
3. Android autonomy uses unified system with WebSocket delivery and notifications
4. Emotional state synchronization works across platforms in real-time
5. Spontaneous initiation, check-ins, and refusals work consistently
6. Background task coordination prevents conflicts and resource issues
7. Platform adapters deliver messages appropriately while using unified logic
</verification>

<success_criteria>
Unified autonomy integration is complete when:
- All platform-specific autonomy replaced with unified system
- Cross-platform emotional state synchronization works reliably
- Autonomous behavior is consistent across Discord and Android
- Background task management prevents memory leaks and conflicts
- Platform-specific formatting preserved while using unified content
- Integration tests pass with >90% coverage
- All autonomy requirements (AUTO-03, AUTO-04, AUTO-05) verified complete
- System shows no degradation in performance or reliability
</success_criteria>

<output>
After completion, create `.planning/phases/07-autonomy-&-rambles/07-04-SUMMARY.md`
</output>