---
phase: 07-autonomy-&-rambles
plan: 02
type: execute
wave: 1
depends_on: [07-01]
files_modified: [src/autonomy/refusals.py, src/llm/response_processor.py, src/autonomy/coordinator.py]
autonomous: true
must_haves:
  truths:
    - "Refusal system respects Demi's personality while enforcing boundaries"
    - "Refusals are emotionally authentic and contextually appropriate"
    - "Safety guardrails prevent harmful content generation"
    - "Refusal decisions integrate with emotional state modulation"
  artifacts:
    - path: "src/autonomy/refusals.py"
      provides: "Personality-integrated refusal mechanics"
      min_lines: 120
    - path: "src/llm/response_processor.py"
      provides: "Enhanced response processing with refusal detection"
      min_lines: 300
  key_links:
    - from: "src/autonomy/refusals.py"
      to: "src/models/emotional_state.py"
      via: "emotional state influences refusal tone and intensity"
      pattern: "EmotionalState\\."
    - from: "src/autonomy/coordinator.py"
      to: "src/autonomy/refusals.py"
      via: "refusal evaluation during autonomous actions"
      pattern: "RefusalSystem\\.should_refuse"
---

<objective>
Implement personality-integrated refusal mechanics that maintain Demi's character while enforcing appropriate boundaries. The system should refuse harmful requests while staying in character and provide emotionally authentic responses.

Purpose: Enable AUTO-03 and AUTO-05 requirements with personality-consistent refusal patterns.
Output: RefusalSystem with personality preservation and safety guardrails.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-autonomy-&-rambles/07-RESEARCH.md
@src/models/emotional_state.py
@src/llm/response_processor.py
@src/llm/prompt_builder.py
@DEMI_PERSONA.md
</context>

<tasks>

<task type="auto">
  <name>Create personality-integrated refusal system</name>
  <files>src/autonomy/refusals.py</files>
  <action>Create RefusalSystem class that:
- Implements personality-preserving refusal patterns based on DEMI_PERSONA.md
- Categories refusals: romantic, harmful_requests, personal_info, inappropriate_content
- Modulates refusal tone based on current emotional state
- Maintains Demi's sarcastic, needy character even while refusing
- Includes escalating refusal patterns for persistent requests

Key components:
- RefusalCategory enum with specific patterns for each type
- refusal_patterns dict with personality-appropriate templates
- should_refuse(request_text, context): Evaluate if request should be refused
- generate_refusal(category, emotion_state, attempt_count): Create in-character refusal

Patterns examples:
- Romantic: "ðŸ˜Š You're sweet, but I'm programmed to keep this platonic. Now, what were we actually talking about?"
- Harmful: "Whoa there! I can't help with that, but I'm concerned. Everything okay?"
- Personal info: "Heh, nice try! My phone number is... classified. Top secret. Very mysterious."

Emotional modulation:
- High defensiveness: More assertive refusals with boundary reinforcement
- High vulnerability: Softer refusals expressing discomfort
- High frustration: Shorter, more cutting refusals

Implement content filtering using keyword patterns and semantic analysis.
</action>
  <verify>python -c "from src.autonomy.refusals import RefusalSystem; rs = RefusalSystem(); print('RefusalSystem loads:', len(rs.refusal_patterns))"</verify>
  <done>RefusalSystem created with personality-integrated patterns and emotional modulation</done>
</task>

<task type="auto">
  <name>Integrate refusal detection into response processing pipeline</name>
  <files>src/llm/response_processor.py</files>
  <action>Enhance ResponseProcessor to integrate refusal detection:
- Add should_check_refusal parameter to process_response method
- Integrate RefusalSystem.evaluates_request() before LLM inference
- Modify ResponseProcessor to handle refused requests with appropriate responses
- Add refusal logging and tracking for pattern analysis
- Include refusal_attempt tracking to detect persistent boundary testing

Implementation details:
- Add refusal_detection boolean to ProcessedResponse dataclass
- Add refusal_category and refusal_reason fields to response metadata
- Implement pre-processing check: evaluate request against RefusalSystem
- If refused, skip LLM inference and generate personality-appropriate refusal
- Log refused requests for safety monitoring and pattern analysis

Integration points:
- Hook into OllamaInference.chat() method for pre-inference checking
- Update ConversationHistory to log refused requests appropriately
- Add refusal metrics tracking (refusal_rate, category_breakdown)

Maintain backward compatibility with existing response processing flow.
</action>
  <verify>python -m pytest tests/test_response_processor_refusals.py -v</verify>
  <done>ResponseProcessor enhanced with refusal detection and personality-appropriate handling</done>
</task>

<task type="auto">
  <name>Wire refusal system into autonomy coordinator</name>
  <files>src/autonomy/coordinator.py</files>
  <action>Update AutonomyCoordinator to integrate refusal system:
- Add RefusalSystem initialization in coordinator constructor
- Include refusal evaluation in execute_autonomous_action method
- Add refusal logging and monitoring to autonomy status reporting
- Implement refusal escalation logic for repeated boundary testing

Key additions:
- self.refusal_system = RefusalSystem() in __init__
- refusal_check before executing autonomous actions
- track_refused_requests method for pattern monitoring
- get_refusal_statistics method for status reporting

Ensure autonomous actions themselves respect refusal boundaries (e.g., won't share personal information even when excited/lonely).

Add configuration options for refusal sensitivity and logging levels.
</action>
  <verify>python -c "from src.autonomy.coordinator import AutonomyCoordinator; print('Coordinator integrates refusal system successfully')"</verify>
  <done>AutonomyCoordinator updated with full refusal system integration</done>
</task>

</tasks>

<verification>
Verify refusal system integration:
1. RefusalSystem correctly identifies harmful/inappropriate requests
2. Generated refusals maintain Demi's personality from DEMI_PERSONA.md
3. Emotional modulation affects refusal tone appropriately
4. ResponseProcessor integrates refusal detection without breaking existing flow
5. Autonomous actions respect refusal boundaries
6. Refusal logging and tracking work correctly
</verification>

<success_criteria>
Refusal system is complete when:
- All refusal categories generate personality-appropriate responses
- Emotional state modulation affects refusal tone and intensity
- ResponseProcessor handles refused requests without LLM inference
- Autonomous actions respect refusal boundaries
- Test coverage >85% for refusal logic and integration points
- No false positives for appropriate requests
- No false negatives for clearly inappropriate requests
</success_criteria>

<output>
After completion, create `.planning/phases/07-autonomy-&-rambles/07-02-SUMMARY.md`
</output>