---
phase: 07-autonomy-&-rambles
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/autonomy/__init__.py, src/autonomy/coordinator.py, src/autonomy/triggers.py, src/autonomy/config.py]
autonomous: true
must_haves:
  truths:
    - "Autonomy coordinator manages all autonomous behavior across platforms"
    - "Emotional triggers fire based on configurable thresholds"
    - "Background task scheduler prevents task accumulation"
    - "Unified configuration allows runtime tuning of autonomous behavior"
  artifacts:
    - path: "src/autonomy/coordinator.py"
      provides: "Central autonomy coordination across platforms"
      min_lines: 80
    - path: "src/autonomy/triggers.py"
      provides: "Emotional trigger logic with cooldown management"
      min_lines: 100
    - path: "src/autonomy/config.py"
      provides: "Configuration management for autonomous behavior"
      min_lines: 40
  key_links:
    - from: "src/autonomy/coordinator.py"
      to: "src/models/emotional_persistence.py"
      via: "load_state() for emotional state"
      pattern: "EmotionPersistence\\.load_state"
    - from: "src/autonomy/triggers.py"
      to: "src/models/emotional_state.py"
      via: "emotional state values for trigger evaluation"
      pattern: "EmotionalState\\."
---

<objective>
Build the foundational autonomy coordination system that manages emotional triggers, background task scheduling, and unified configuration for autonomous behavior across Discord and Android platforms.

Purpose: Replace platform-specific autonomy with unified system for consistent behavior.
Output: AutonomyCoordinator, EmotionalTrigger system, and configuration management.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-autonomy-&-rambles/07-RESEARCH.md
@src/models/emotional_state.py
@src/models/emotional_persistence.py
@src/integrations/discord_bot.py
@src/api/autonomy.py
</context>

<tasks>

<task type="auto">
  <name>Create AutonomyCoordinator for unified autonomous behavior management</name>
  <files>src/autonomy/coordinator.py</files>
  <action>Create AutonomyCoordinator class that:
- Manages all autonomous behavior across Discord and Android platforms
- Coordinates with Conductor for LLM access and platform integration
- Implements robust background task lifecycle (start/stop/cleanup)
- Provides unified interface for emotional triggers and autonomous actions
- Integrates with existing emotional state persistence via EmotionPersistence
- Prevents task accumulation through proper reference tracking and cleanup
- Supports platform-specific message delivery (Discord embeds, Android WebSocket)

Key methods:
- __init__(self, conductor, logger): Initialize with dependencies
- start_autonomy(): Start background tasks with proper error handling
- stop_autonomy(): Graceful shutdown with task cleanup
- execute_autonomous_action(action_type, context): Execute action on appropriate platform
- get_autonomy_status(): Return current status and health

Include comprehensive error handling and logging integration.
</action>
  <verify>python -c "from src.autonomy.coordinator import AutonomyCoordinator; print('Coordinator imports successfully')"</verify>
  <done>AutonomyCoordinator created with proper lifecycle management and platform integration</done>
</task>

<task type="auto">
  <name>Implement emotional trigger system with cooldown management</name>
  <files>src/autonomy/triggers.py</files>
  <action>Create emotional trigger system that:
- Defines EmotionalTrigger class with configurable thresholds and cooldowns
- Implements trigger evaluation based on current emotional state
- Manages cooldown periods to prevent trigger spam
- Supports multiple trigger types (loneliness, excitement, frustration, jealousy)
- Includes trigger priority system to handle conflicting triggers
- Provides trigger history tracking for debugging and tuning

Key classes:
- EmotionalTrigger(emotion, threshold, cooldown_minutes, priority)
- TriggerManager(manages multiple triggers, evaluation, cooldown tracking)

Implementation details:
- Use datetime.now(UTC) for consistent timing (matches existing codebase)
- Implement ExponentialBackoff for repeated failed triggers
- Add trigger decay for repeated firings (prevents spam)
- Include configurable trigger filters (time of day, platform availability)

Create tests for trigger logic including edge cases and cooldown behavior.
</action>
  <verify>python -m pytest tests/test_autonomy_triggers.py -v</verify>
  <done>EmotionalTrigger system created with proper cooldown management and priority handling</done>
</task>

<task type="auto">
  <name>Build unified configuration system for autonomous behavior</name>
  <files>src/autonomy/config.py</files>
  <action>Create autonomy configuration system that:
- Defines AutonomyConfig dataclass with Pydantic validation
- Supports configuration from environment variables and config files
- Provides sensible defaults for all autonomous behavior settings
- Allows runtime configuration updates without restart
- Includes validation for thresholds and timing values
- Integrates with existing config system patterns

Configuration sections:
- trigger_thresholds: Emotional trigger thresholds (loneliness: 0.7, etc.)
- timing_settings: Intervals and cooldowns (check_interval: 900, etc.)
- platform_settings: Platform-specific settings (ramble_channel_id, etc.)
- safety_limits: Rate limiting and spam prevention (max_autonomous_per_hour: 5)

Support hot-reload of configuration changes and logging of config updates.
</action>
  <verify>python -c "from src.autonomy.config import AutonomyConfig; config = AutonomyConfig(); print('Config loads successfully:', len(config.__dict__))"</verify>
  <done>AutonomyConfig created with Pydantic validation and environment variable support</done>
</task>

</tasks>

<verification>
Verify autonomy foundation:
1. AutonomyCoordinator initializes without errors
2. Emotional triggers evaluate correctly with test emotional states
3. Configuration loads from environment variables and validates properly
4. Background task lifecycle management works (start/stop/cleanup)
5. Integration with existing emotional state persistence functions
</verification>

<success_criteria>
Autonomy foundation is ready when:
- AutonomyCoordinator can start/stop background tasks without memory leaks
- EmotionalTrigger system correctly evaluates triggers with proper cooldowns
- AutonomyConfig loads from environment and validates all settings
- All components integrate with existing emotional state and persistence systems
- Test suite passes with >80% coverage for autonomy components
</success_criteria>

<output>
After completion, create `.planning/phases/07-autonomy-&-rambles/07-01-SUMMARY.md`
</output>