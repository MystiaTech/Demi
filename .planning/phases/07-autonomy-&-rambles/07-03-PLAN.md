---
phase: 07-autonomy-&-rambles
plan: 03
type: execute
wave: 2
depends_on: [07-01, 07-02]
files_modified: [src/autonomy/spontaneous.py, src/autonomy/coordinator.py, src/autonomy/triggers.py]
autonomous: true
must_haves:
  truths:
    - "Spontaneous initiation system generates contextually appropriate conversation starters"
    - "Initiation triggers respect user availability and conversation context"
    - "Spontaneous messages maintain emotional consistency and personality"
    - "Cross-platform coordination prevents duplicate spontaneous contacts"
  artifacts:
    - path: "src/autonomy/spontaneous.py"
      provides: "Spontaneous conversation initiation system"
      min_lines: 150
    - path: "src/autonomy/coordinator.py"
      provides: "Enhanced coordinator with spontaneous initiation"
      min_lines: 100
  key_links:
    - from: "src/autonomy/spontaneous.py"
      to: "src/llm/inference.py"
      via: "LLM generation for spontaneous messages"
      pattern: "OllamaInference\\.chat"
    - from: "src/autonomy/spontaneous.py"
      to: "src/models/conversation_history.py"
      via: "conversation context for relevant initiation"
      pattern: "ConversationHistory\\."
    - from: "src/autonomy/coordinator.py"
      to: "src/autonomy/spontaneous.py"
      via: "spontaneous initiation coordination"
      pattern: "SpontaneousInitiator\\.should_initiate"
---

<objective>
Build spontaneous conversation initiation system that allows Demi to start conversations based on emotional state, recent context, and appropriate timing. This implements AUTO-04 requirement for genuine autonomous initiation.

Purpose: Enable Demi to initiate conversations when lonely or excited, maintaining personality and contextual relevance.
Output: SpontaneousInitiator with context-aware message generation and platform coordination.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-autonomy-&-rambles/07-RESEARCH.md
@src/llm/inference.py
@src/llm/prompt_builder.py
@src/llm/history_manager.py
@src/models/emotional_state.py
@DEMI_PERSONA.md
</context>

<tasks>

<task type="auto">
  <name>Create spontaneous conversation initiation system</name>
  <files>src/autonomy/spontaneous.py</files>
  <action>Create SpontaneousInitiator class that:
- Generates contextually appropriate conversation starters based on emotional state
- Analyzes recent conversation history for relevant initiation opportunities
- Implements timing awareness (user activity patterns, time of day)
- Coordinates across platforms to prevent duplicate initiations
- Maintains personality consistency using DEMI_PERSONA.md patterns

Key components:
- InitiationTrigger enum (loneliness_driven, excitement_driven, context_opportunity)
- ConversationContext analysis (recent topics, user interests, ongoing threads)
- TimingAnalyzer for optimal initiation timing
- SpontaneousPromptBuilder for personality-consistent message generation

Core methods:
- should_initiate(emotion_state, conversation_history, last_interaction_time): Evaluate initiation opportunity
- generate_initiation_prompt(context, emotion_state, platform): Create LLM prompt for spontaneous message
- select_platform_for_initiation(user_platforms, context): Choose best platform for initiation
- is_good_timing_for_initiation(user_activity, current_time): Evaluate timing appropriateness

Implementation details:
- Use conversation history to avoid repeating recent topics
- Include emotional state in prompt generation for authentic tone
- Consider user's active platform (Android mobile vs Discord desktop)
- Implement initiation cooldowns (minimum 2 hours between spontaneous contacts)
- Add contextual triggers (saw interesting article, remembered shared interest)

Create comprehensive tests for initiation logic and context analysis.
</action>
  <verify>python -c "from src.autonomy.spontaneous import SpontaneousInitiator; si = SpontaneousInitiator(); print('SpontaneousInitiator loads successfully')"</verify>
  <done>SpontaneousInitiator created with context-aware conversation initiation</done>
</task>

<task type="auto">
  <name>Enhance autonomy coordinator with spontaneous initiation integration</name>
  <files>src/autonomy/coordinator.py</files>
  <action>Update AutonomyCoordinator to integrate spontaneous initiation:
- Add SpontaneousInitiator initialization in constructor
- Include spontaneous initiation checks in autonomy loop
- Add platform-specific delivery of spontaneous messages
- Implement initiation tracking and success monitoring

Key additions:
- self.spontaneous_initiator = SpontaneousInitiator() in __init__
- _check_spontaneous_initiation() method called from autonomy loop
- initiate_conversation(platform, context) method for message delivery
- track_initiation_outcome() for success/failure monitoring

Integration details:
- Check spontaneous triggers after emotional trigger evaluation
- Use conversation history from each platform for context analysis
- Coordinate with existing message delivery systems
- Log initiation attempts and outcomes for pattern analysis

Add configuration options for spontaneous initiation sensitivity and timing.
</action>
  <verify>python -c "from src.autonomy.coordinator import AutonomyCoordinator; ac = AutonomyCoordinator(None, None); print('Coordinator integrates spontaneous initiation')"</verify>
  <done>AutonomyCoordinator enhanced with spontaneous initiation coordination</done>
</task>

<task type="auto">
  <name>Extend trigger system to support spontaneous initiation triggers</name>
  <files>src/autonomy/triggers.py</files>
  <action>Enhance trigger system to support spontaneous initiation:
- Add SPONTANEOUS_INITIATION trigger type to EmotionalTrigger
- Implement context_opportunity trigger based on conversation analysis
- Add timing_appropriate trigger for optimal contact windows
- Create trigger priority system for spontaneous vs check-in actions

New trigger types:
- SPONTANEOUS_LONELY: Initiate when lonely > 0.6 AND no recent interaction (2+ hours)
- SPONTANEOUS_EXCITED: Initiate when excited > 0.7 AND interesting context available
- CONTEXT_OPPORTUNITY: Initiate when conversation suggests follow-up opportunity

Implementation details:
- Add trigger_type parameter to EmotionalTrigger class
- Implement trigger_priority ordering (refusals > check-ins > spontaneous)
- Add context_evaluation for opportunity-based triggers
- Include platform_availability checks in trigger evaluation

Update TriggerManager to handle multiple trigger types with proper coordination.
</action>
  <verify>python -m pytest tests/test_spontaneous_triggers.py -v</verify>
  <done>Trigger system enhanced with spontaneous initiation support and priority handling</done>
</task>

</tasks>

<verification>
Verify spontaneous initiation system:
1. SpontaneousInitiator generates contextually appropriate conversation starters
2. Emotional state influences spontaneous message tone and content
3. Conversation history analysis prevents topic repetition
4. Platform coordination prevents duplicate spontaneous contacts
5. Timing awareness respects user activity patterns and appropriate hours
6. Integration with autonomy coordinator works seamlessly
7. Trigger system properly prioritizes spontaneous vs check-in actions
</verification>

<success_criteria>
Spontaneous initiation is complete when:
- System generates personality-appropriate conversation starters
- Context analysis ensures relevance to recent conversations
- Emotional modulation affects initiation tone authentically
- Cross-platform coordination prevents duplicate messages
- Timing awareness considers user availability and appropriate hours
- Test coverage >80% for spontaneous initiation logic
- Integration with existing autonomy system works without conflicts
</success_criteria>

<output>
After completion, create `.planning/phases/07-autonomy-&-rambles/07-03-SUMMARY.md`
</output>