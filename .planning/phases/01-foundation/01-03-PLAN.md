---
phase: 01-foundation
plan: 03
type: execute
wave: 1
depends_on: 
  - 01-01
  - 01-02
files_modified: 
  - src/core/database.py
  - src/models/base.py
autonomous: true

must_haves:
  truths:
    - "SQLite database can be created and connected"
    - "Core data models are defined"
    - "Database supports future complexity"
  artifacts:
    - path: src/core/database.py
      provides: "Database connection and management"
      min_lines: 50
    - path: src/models/base.py
      provides: "Core SQLAlchemy base models"
  key_links:
    - from: src/core/database.py
      to: src/core/config.py
      via: "database configuration"
      pattern: "config\\.get_database_config"
---

<objective>
Implement SQLite database integration with SQLAlchemy

Purpose: Create a flexible database layer that supports core models and future emotional complexity
Output: Functional database connection and base model definitions
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/python.md
</execution_context>

<context>
@.planning/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Create Base SQLAlchemy Models</name>
  <files>src/models/base.py</files>
  <action>Define base models and mixins for future extensibility:
- Create a Base declarative base
- Implement TimestampMixin for tracking creation/update times
- Add UUIDMixin for unique identifiers
- Prepare for emotional complexity models

Example implementation:
```python
import uuid
from datetime import datetime
from sqlalchemy import Column, DateTime, String
from sqlalchemy.dialects.sqlite import UUID
from sqlalchemy.ext.declarative import declarative_base

Base = declarative_base()

class TimestampMixin:
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

class UUIDMixin:
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)

class EmotionalEntityBase(Base, TimestampMixin, UUIDMixin):
    __abstract__ = True
    name = Column(String, nullable=False)
    description = Column(String)
```
  </action>
  <verify>python -m pytest tests/test_models.py</verify>
  <done>Base models created with timestamp and UUID support</done>
</task>

<task type="auto">
  <name>Implement Database Connection Manager</name>
  <files>src/core/database.py</files>
  <action>Create a DatabaseManager class with:
- SQLAlchemy engine creation
- Session management
- Connection pooling
- Integration with configuration system
- Context manager for database transactions

Example implementation:
```python
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker, scoped_session
from src.models.base import Base

class DatabaseManager:
    def __init__(self, config):
        self.config = config
        self.engine = self._create_engine()
        self.SessionLocal = scoped_session(sessionmaker(bind=self.engine))

    def _create_engine(self):
        db_config = self.config.get('database', {})
        db_path = db_config.get('path', './data/demi.db')
        engine = create_engine(f'sqlite:///{db_path}', 
                               connect_args={'check_same_thread': False})
        Base.metadata.create_all(engine)
        return engine

    def get_session(self):
        return self.SessionLocal()

    def close_session(self):
        self.SessionLocal.remove()

    def __enter__(self):
        return self.get_session()

    def __exit__(self, exc_type, exc_val, exc_tb):
        self.close_session()
```
  </action>
  <verify>
mkdir -p data && python -c "
from src.core.config import ConfigManager
from src.core.database import DatabaseManager
config = ConfigManager()
db_manager = DatabaseManager(config)
session = db_manager.get_session()
session.close()
"
  </verify>
  <done>Database connection manager created with SQLite support</done>
</task>

<task type="checkpoint:human-verify">
  <name>Verify Database Integration</name>
  <how-to-verify>
1. Check data/demi.db is created
2. Verify database connection works
3. Ensure base models can be instantiated
4. Test transaction management
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- SQLite database can be created
- Base models defined with mixins
- Database manager supports transactions
- Configuration integrated with database setup
</verification>

<success_criteria>
1. SQLite database schema created
2. Base models support timestamps and UUIDs
3. Database connection management works
4. Prepared for future model complexity
</success_criteria>

<output>
Create `.planning/phases/01-foundation/01-03-SUMMARY.md` after successful execution
</output>