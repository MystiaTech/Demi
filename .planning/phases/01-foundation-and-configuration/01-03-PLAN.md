---
phase: 01-foundation-and-configuration
plan: 01-03
type: execute
wave: 1
depends_on: ["01-01", "01-02"]
files_modified: ["src/core/database.py", "src/models/base.py"]
autonomous: true

must_haves:
  truths:
    - "SQLite database can be created and connected"
    - "Core data models are defined"
    - "Database supports future complexity"
  artifacts:
    - path: "src/core/database.py"
      provides: "Database connection and session management"
      min_lines: 75
    - path: "src/models/base.py"
      provides: "Base model definitions for emotional state tracking"
      min_lines: 50
  key_links:
    - from: "src/core/database.py"
      to: "models/base.py"
      via: "declarative base"
      pattern: "declarative_base\\(\\)"
---

<objective>
Implement SQLite database integration with SQLAlchemy for Demi's core data persistence

Purpose: Create a flexible database layer that supports emotional state tracking and future system complexity

Output: Robust database connection manager and core model definitions
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/core/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Base Model Definitions</name>
  <files>src/models/base.py</files>
  <action>Define base models for emotional state and interaction tracking:
    ```python
    import os
    from datetime import datetime
    from sqlalchemy import Column, Integer, Float, String, DateTime, JSON, Boolean
    from sqlalchemy.ext.declarative import declarative_base
    from sqlalchemy.orm import relationship

    Base = declarative_base()

    class EmotionalState(Base):
        """Track Demi's emotional state with detailed persistence"""
        __tablename__ = 'emotional_states'

        id = Column(Integer, primary_key=True)
        timestamp = Column(DateTime, default=datetime.utcnow)
        
        # Core emotions
        loneliness = Column(Float, default=0.0)
        excitement = Column(Float, default=0.0)
        frustration = Column(Float, default=0.0)
        jealousy = Column(Float, default=0.0)
        vulnerable = Column(Boolean, default=False)

        # Emotional metadata
        interaction_context = Column(JSON, nullable=True)
        decay_multiplier = Column(Float, default=1.0)

        def __repr__(self):
            return f"<EmotionalState(timestamp={self.timestamp}, loneliness={self.loneliness})>"

    class Interaction(Base):
        """Record individual interactions for emotional learning"""
        __tablename__ = 'interactions'

        id = Column(Integer, primary_key=True)
        timestamp = Column(DateTime, default=datetime.utcnow)
        platform = Column(String)  # e.g., 'discord', 'android'
        interaction_type = Column(String)  # e.g., 'message', 'ramble', 'command'
        content = Column(String)
        emotional_impact = Column(JSON)

        def __repr__(self):
            return f"<Interaction(platform={self.platform}, type={self.interaction_type})>"

    class PlatformStatus(Base):
        """Track status of different platform integrations"""
        __tablename__ = 'platform_status'

        id = Column(Integer, primary_key=True)
        platform_name = Column(String, unique=True)
        enabled = Column(Boolean, default=False)
        last_active = Column(DateTime, nullable=True)
        connection_failures = Column(Integer, default=0)

        def __repr__(self):
            return f"<PlatformStatus(platform={self.platform_name}, enabled={self.enabled})>"
    ```</action>
  <verify>python -c "from sqlalchemy import create_engine; from src.models.base import Base, EmotionalState, Interaction, PlatformStatus; engine = create_engine('sqlite:///:memory:'); Base.metadata.create_all(engine)"</verify>
  <done>Base models created for emotional state tracking, interactions, and platform status</done>
</task>

<task type="auto">
  <name>Task 2: Implement Database Connection and Session Management</name>
  <files>src/core/database.py</files>
  <action>Create database connection manager with SQLAlchemy:
    ```python
    import os
    from contextlib import contextmanager
    from sqlalchemy import create_engine
    from sqlalchemy.orm import sessionmaker, scoped_session
    from src.core.config import DemiConfig
    from src.core.logger import logger
    from src.models.base import Base

    class DatabaseManager:
        _instance = None

        def __new__(cls, config=None):
            if not cls._instance:
                cls._instance = super().__new__(cls)
                cls._instance._initialize(config)
            return cls._instance

        def _initialize(self, config=None):
            """Initialize database connection"""
            if config is None:
                config = DemiConfig.load()

            # Ensure .demi directory exists
            demi_dir = os.path.expanduser('~/.demi')
            os.makedirs(demi_dir, exist_ok=True)

            # Database path with robust handling
            db_path = os.path.join(demi_dir, 'demi.sqlite')
            self.engine = create_engine(
                f'sqlite:///{db_path}',
                connect_args={'check_same_thread': False},
                echo=config.system.get('debug', False)
            )

            # Create all tables
            Base.metadata.create_all(self.engine)

            # Configure session factory
            session_factory = sessionmaker(bind=self.engine)
            self.Session = scoped_session(session_factory)

            logger.info(f"Database initialized at {db_path}")

        @contextmanager
        def session_scope(self):
            """Provide a transactional scope around a series of operations."""
            session = self.Session()
            try:
                yield session
                session.commit()
            except Exception as e:
                session.rollback()
                logger.error(f"Database transaction failed: {e}")
                raise
            finally:
                session.close()

        def create_tables(self):
            """Force recreation of all tables"""
            Base.metadata.drop_all(self.engine)
            Base.metadata.create_all(self.engine)
            logger.info("Database tables recreated")

    # Global database manager instance
    db_manager = DatabaseManager()
    ```</action>
  <verify>python -c "from src.core.database import db_manager; with db_manager.session_scope() as session: assert session is not None"</verify>
  <done>Comprehensive database connection manager created with session handling and logging</done>
</task>

</tasks>

<verification>
1. Verify database file is created in ~/.demi/
2. Test table creation and schema
3. Validate session management
4. Check logging during database operations
5. Ensure thread-safe database access
</verification>

<success_criteria>
1. SQLite database created with correct schema
2. Database supports emotional state, interaction, and platform status tracking
3. Session management handles transactions safely
4. Debug logging can be enabled/disabled
5. Database path is consistent and configurable
</success_criteria>

<output>
Create .planning/phases/01-foundation-and-configuration/01-03-SUMMARY.md after execution
</output>