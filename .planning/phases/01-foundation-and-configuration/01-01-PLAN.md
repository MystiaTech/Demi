---
phase: 01-foundation-and-configuration
plan: 01-01
type: execute
wave: 1
depends_on: []
files_modified: ["src/core/config.py", "src/core/defaults.yaml"]
autonomous: true

must_haves:
  truths:
    - "Configuration can be read from file"
    - "Default values exist for all settings"
    - "Runtime configuration updates possible"
  artifacts:
    - path: "src/core/config.py"
      provides: "Configuration management"
      min_lines: 50
    - path: "src/core/defaults.yaml"
      provides: "Default configuration values"
  key_links:
    - from: "src/core/config.py"
      to: "config file"
      via: "environs library"
      pattern: "env\\.read_env"
---

<objective>
Implement robust configuration management for Demi's core system

Purpose: Establish a flexible, environment-aware configuration system that supports runtime updates and provides default values

Output: Functional configuration module with YAML support and environment variable overrides
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/core/defaults.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Default Configuration File</name>
  <files>src/core/defaults.yaml</files>
  <action>Create a comprehensive defaults.yaml with nested configuration for all Demi subsystems:
    ```yaml
    system:
      debug: false
      log_level: INFO
      ram_threshold: 80

    emotional_system:
      decay_rates:
        loneliness: 0.1
        excitement: 0.2
      persistence_interval: 300  # 5 minutes

    platforms:
      discord:
        enabled: true
        auto_reconnect: true
      android:
        enabled: false
        notification_frequency: 3  # per hour
    ```</action>
  <verify>yamllint src/core/defaults.yaml && python -c "import yaml; yaml.safe_load(open('src/core/defaults.yaml'))"</verify>
  <done>Default configuration file exists with valid YAML structure covering system, emotional, and platform configurations</done>
</task>

<task type="auto">
  <name>Task 2: Implement Configuration Management Module</name>
  <files>src/core/config.py</files>
  <action>Create configuration management module using environs and PyYAML:
    ```python
    import os
    import yaml
    from environs import Env
    from dataclasses import dataclass, asdict
    from typing import Dict, Any

    @dataclass
    class DemiConfig:
        system: Dict[str, Any]
        emotional_system: Dict[str, Any]
        platforms: Dict[str, Any]

        @classmethod
        def load(cls, config_path='src/core/defaults.yaml'):
            with open(config_path, 'r') as f:
                defaults = yaml.safe_load(f)
            
            env = Env()
            # Override defaults with environment variables
            config = {
                'system': {
                    **defaults['system'],
                    'debug': env.bool('DEMI_DEBUG', defaults['system']['debug']),
                    'log_level': env.str('DEMI_LOG_LEVEL', defaults['system']['log_level'])
                },
                'emotional_system': {
                    **defaults['emotional_system'],
                    'decay_rates': {
                        **defaults['emotional_system']['decay_rates'],
                        'loneliness': env.float('DEMI_LONELINESS_DECAY', defaults['emotional_system']['decay_rates']['loneliness'])
                    }
                },
                'platforms': {
                    **defaults['platforms'],
                    'discord': {
                        **defaults['platforms']['discord'],
                        'enabled': env.bool('DEMI_DISCORD_ENABLED', defaults['platforms']['discord']['enabled'])
                    },
                    'android': {
                        **defaults['platforms']['android'],
                        'enabled': env.bool('DEMI_ANDROID_ENABLED', defaults['platforms']['android']['enabled'])
                    }
                }
            }
            return cls(**config)

        def update(self, section: str, key: str, value: Any):
            """Update a specific configuration value at runtime"""
            if section not in ['system', 'emotional_system', 'platforms']:
                raise ValueError(f"Invalid configuration section: {section}")
            
            current_section = getattr(self, section)
            current_section[key] = value
            setattr(self, section, current_section)
    ```</action>
  <verify>python -c "from src.core.config import DemiConfig; cfg = DemiConfig.load(); assert 'system' in cfg.__dict__"</verify>
  <done>Configuration module created with defaults loading, environment variable override, and runtime update capabilities</done>
</task>

</tasks>

<verification>
1. Verify configuration file created with correct structure
2. Test configuration loading with default and environment-specific settings
3. Confirm runtime configuration updates work
4. Validate all configuration sections are present
</verification>

<success_criteria>
1. Configuration module loads successfully
2. Environment variables can override default settings
3. Runtime configuration updates possible
4. Default configuration covers all known subsystems
</success_criteria>

<output>
Create .planning/phases/01-foundation-and-configuration/01-01-SUMMARY.md after execution
</output>