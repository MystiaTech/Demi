---
phase: 02-conductor-orchestrator-integration-manager
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [src/conductor/__init__.py, src/conductor/health.py, src/conductor/circuit_breaker.py, src/conductor/metrics.py]
autonomous: true
must_haves:
  truths:
    - "Health monitoring runs every 5 seconds with staggered platform checks"
    - "Circuit breaker protects against cascading failures with 3-failure threshold"
    - "Prometheus metrics track health checks, response times, and failure rates"
    - "Staggered execution prevents resource spikes during health monitoring"
  artifacts:
    - path: "src/conductor/health.py"
      provides: "Health monitoring system with 5-second intervals"
      contains: "class HealthMonitor"
      min_lines: 60
    - path: "src/conductor/circuit_breaker.py"
      provides: "Circuit breaker protection with 3-failure threshold"
      contains: "class PlatformCircuitBreaker"
      min_lines: 40
    - path: "src/conductor/metrics.py"
      provides: "Prometheus metrics collection for health monitoring"
      contains: "health_check_counter, response_time_histogram"
      min_lines: 30
  key_links:
    - from: "src/conductor/health.py"
      to: "src/conductor/circuit_breaker.py"
      via: "circuit breaker state management during health checks"
      pattern: "circuit_breaker\\.record_result"
    - from: "src/conductor/health.py"
      to: "src/conductor/metrics.py"
      via: "metrics recording for each health check"
      pattern: "health_check_counter\\.inc"
    - from: "src/conductor/circuit_breaker.py"
      to: "src/plugins/manager.py"
      via: "plugin health status affecting circuit state"
      pattern: "plugin_health\\.status"
---

<objective>
Implement the health monitoring and circuit breaker system for Demi's conductor. This provides continuous monitoring of all platform integrations with 5-second intervals, protects against cascading failures through circuit breakers, and collects comprehensive metrics for observability.

Purpose: Ensure platform failures are detected quickly and isolated to prevent system-wide crashes.
Output: Working health monitoring system with circuit breaker protection and Prometheus metrics.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@src/core/config.py
@src/core/logger.py
</context>

<tasks>

<task type="auto">
  <name>Create Prometheus metrics system</name>
  <files>src/conductor/__init__.py, src/conductor/metrics.py</files>
  <action>
    Create metrics collection system:
    - __init__.py exports metrics classes and functions
    - metrics.py with aioprometheus integration:
      * health_check_total counter with labels [platform, status]
      * health_check_duration_seconds histogram with labels [platform]
      * circuit_breaker_state gauge with labels [platform, state]
      * plugin_failure_total counter with labels [platform, error_type]
      * system_resources gauge for RAM/CPU usage
    - Include get_metrics_registry() function for Prometheus scraping
    - Add init_metrics() to register all metrics
    - Use structlog for metric-related logging
  </action>
  <verify>python -c "from src.conductor.metrics import get_metrics_registry; print('Metrics system initialized successfully')"</verify>
  <done>Prometheus metrics system ready for health monitoring and circuit breaker data</done>
</task>

<task type="auto">
  <name>Implement circuit breaker protection</name>
  <files>src/conductor/circuit_breaker.py</files>
  <action>
    Create circuit breaker system:
    - PlatformCircuitBreaker class using aiobreaker
    - Configuration: fail_max=3, reset_timeout=30 seconds
    - States tracking: CLOSED, OPEN, HALF_OPEN
    - record_success() and record_failure() methods
    - can_execute() method checking circuit state
    - get_state() returning current state and failure count
    - Metrics integration with circuit_breaker_state gauge
    - Async support for all methods
    - Integration with existing config system for thresholds
  </action>
  <verify>python -c "
import asyncio
from src.conductor.circuit_breaker import PlatformCircuitBreaker
async def test():
    cb = PlatformCircuitBreaker('test')
    print(f'Circuit breaker state: {cb.get_state()}')
asyncio.run(test())
"</verify>
  <done>Circuit breaker system protects against cascading failures with 3-failure threshold</done>
</task>

<task type="auto">
  <name>Build health monitoring system</name>
  <files>src/conductor/health.py</files>
  <action>
    Create comprehensive health monitoring:
    - HealthMonitor class with 5-second check interval
    - staggered_health_checks() using asyncio.gather with delays
    - check_platform_health() for individual platforms with 5-second timeout
    - health_check_loop() main monitoring loop
    - Integration with circuit breaker for each platform
    - Metrics recording for each check (duration, status, errors)
    - Resource monitoring via psutil (RAM, CPU, disk)
    - Degraded mode handling when resources >80%
    - Configurable check intervals and timeouts
    - Proper error handling and logging
  </action>
  <verify>python -c "
import asyncio
from src.conductor.health import HealthMonitor
async def test():
    hm = HealthMonitor()
    print('Health monitor initialized successfully')
    # Test staggered execution
    platforms = ['test1', 'test2', 'test3']
    results = await hm.staggered_health_checks(platforms, lambda: True)
    print(f'Staggered checks completed: {len(results)}')
asyncio.run(test())
"</verify>
  <done>Health monitoring system runs 5-second checks with staggered execution and circuit breaker integration</done>
</task>

</tasks>

<verification>
Overall verification steps:
1. Verify metrics are properly registered and can be scraped
2. Test circuit breaker state transitions (CLOSED → OPEN → HALF_OPEN)
3. Run health monitoring loop and check staggered execution timing
4. Verify resource monitoring thresholds work correctly
5. Test degraded mode behavior when resources are constrained
</verification>

<success_criteria>
- Health checks run every 5 seconds with staggered platform execution
- Circuit breaker opens after 3 consecutive failures and recovers properly
- Prometheus metrics track all health monitoring activities
- Resource monitoring triggers degradation at 80% RAM usage
- System remains stable during platform failures
</success_criteria>

<output>
After completion, create `.planning/phases/02-conductor-orchestrator-integration-manager/02-02-SUMMARY.md`
</output>